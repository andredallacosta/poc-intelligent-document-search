# ADR 001 — Banco de Dados com PostgreSQL + pgvector

## Status

Aceito ✅

## Contexto

O sistema precisa:

* Armazenar **documentos gerais** (leis, regulamentos e normas) que serão usados por múltiplas prefeituras.
* Suportar até **50 usuários iniciais**, com possibilidade de escalar no futuro.
* Permitir **consultas em linguagem natural** utilizando embeddings.
* Manter **histórico de conversas** por usuário, permitindo auditoria, justificativa de consumo de tokens e prevenção de uso indevido.
* Controlar **quotas de tokens por prefeitura** para justificar gastos e permitir rate limiting.
* Custos mensais devem permanecer abaixo de **R\$ 500** na fase inicial.

Decisão importante: neste momento, **os documentos são únicos e globais**, e não segregados por prefeitura. Caso seja necessário no futuro, haverá evolução para multi-prefeitura com isolamento de documentos.

## Decisão

* O banco de dados principal será o **PostgreSQL**, hospedado no **Amazon RDS**.
* Usaremos a extensão **pgvector** para armazenar embeddings e realizar buscas semânticas.
* A estrutura inicial conterá:

  * **Tabela de prefeituras**: quotas e consumo de tokens.
  * **Tabela de usuários**: autenticados, vinculados a uma prefeitura.
  * **Tabela de documentos**: documentos gerais, com link para armazenamento em S3.
  * **Tabela de embeddings**: chunks de documentos vetorizados para busca semântica.
  * **Tabela de conversas**: histórico de interações, perguntas, respostas e tokens consumidos.
* Armazenamento de arquivos originais será feito no **Amazon S3**, com apenas os metadados no PostgreSQL.
* Monitoramento de consumo por prefeitura será feito via agregação de histórico de conversas.

## Esquema inicial

```sql
-- Prefeituras
CREATE TABLE prefeitura (
    id SERIAL PRIMARY KEY,
    nome TEXT NOT NULL,
    quota_tokens INT NOT NULL,
    tokens_consumidos INT DEFAULT 0
);

-- Usuários
CREATE TABLE usuario (
    id SERIAL PRIMARY KEY,
    prefeitura_id INT REFERENCES prefeitura(id),
    nome TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    senha_hash TEXT NOT NULL,
    criado_em TIMESTAMP DEFAULT NOW()
);

-- Documentos gerais
CREATE TABLE documento (
    id SERIAL PRIMARY KEY,
    titulo TEXT NOT NULL,
    descricao TEXT,
    caminho_s3 TEXT NOT NULL,
    criado_em TIMESTAMP DEFAULT NOW()
);

-- Embeddings (pgvector)
CREATE TABLE documento_embedding (
    id SERIAL PRIMARY KEY,
    documento_id INT REFERENCES documento(id),
    chunk TEXT NOT NULL,
    embedding VECTOR(1536), -- ajustado ao modelo de embedding
    criado_em TIMESTAMP DEFAULT NOW()
);

-- Histórico de conversas
CREATE TABLE conversa (
    id SERIAL PRIMARY KEY,
    usuario_id INT REFERENCES usuario(id),
    pergunta TEXT NOT NULL,
    resposta TEXT,
    tokens_usados INT,
    criado_em TIMESTAMP DEFAULT NOW()
);
```

## Consequências

### Positivas

* PostgreSQL no RDS traz **confiabilidade, backups automáticos e monitoramento**.
* Estrutura **simples, robusta e escalável**.
* Embeddings ficam junto ao banco principal, evitando complexidade inicial de usar vetor DB dedicado.
* Histórico de conversas garante **auditoria e justificativa de gastos**.
* Estrutura já preparada para evoluir para multi-prefeitura sem grandes mudanças.

### Negativas

* Custos de RDS são mais altos que hospedar banco em container próprio (Lightsail), mas compensam pela confiabilidade.
* Escalabilidade limitada no pgvector comparado a soluções dedicadas (ex: Pinecone, Weaviate), mas suficiente para o MVP.
* Documentos são **compartilhados por todas as prefeituras** na versão inicial — pode ser um ponto de confusão futura se cada prefeitura precisar de repositório exclusivo.

## Alternativas consideradas

1. **MongoDB Atlas + Atlas Vector Search**

   * Vantagem: documentos e embeddings juntos em DB orientado a documentos.
   * Desvantagem: custos mais altos, curva de aprendizado.

2. **Banco vetorial dedicado (Pinecone, Weaviate, Milvus)**

   * Vantagem: performance superior em grandes volumes.
   * Desvantagem: custos adicionais e complexidade desnecessária no MVP.

3. **Banco único em container (Postgres no Lightsail)**

   * Vantagem: custo menor.
   * Desvantagem: falta de backup gerenciado, risco maior de indisponibilidade.

Decidimos pelo **PostgreSQL + pgvector no RDS** como melhor equilíbrio entre custo, robustez e simplicidade.
