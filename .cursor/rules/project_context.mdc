---
alwaysApply: true
---

# Intelligent Document Search API v2.0 - Clean Architecture

## ğŸ¯ PROJECT OVERVIEW

**Production-ready** conversational AI system with RAG (Retrieval-Augmented Generation) using GPT-4o-mini and Clean Architecture principles.

### **Current Status** âœ…

- âœ… Clean Architecture with Domain-Driven Design
- âœ… Conversational AI with session management  
- âœ… RAG pipeline: PostgreSQL + pgvector + OpenAI embeddings
- âœ… Multi-tenancy ready (Prefeitura, Usuario entities)
- âœ… FastAPI with dependency injection
- âœ… Docker containerization optimized
- âœ… Rate limiting and monitoring

## ğŸ—ï¸ CLEAN ARCHITECTURE STRUCTURE

```
ğŸ“ intelligent-document-search/
â”œâ”€â”€ ğŸŒ interface/              # Interface Layer (FastAPI)
â”‚   â”œâ”€â”€ api/v1/endpoints/      # REST endpoints
â”‚   â”œâ”€â”€ schemas/               # Pydantic models
â”‚   â”œâ”€â”€ dependencies/          # DI container
â”‚   â””â”€â”€ main.py               # Entry point
â”‚
â”œâ”€â”€ ğŸ¯ application/            # Application Layer (Use Cases)
â”‚   â”œâ”€â”€ use_cases/            # Business use cases
â”‚   â”œâ”€â”€ dto/                  # Data Transfer Objects
â”‚   â””â”€â”€ interfaces/           # Service contracts
â”‚
â”œâ”€â”€ ğŸ’ domain/                # Domain Layer (Business Logic)
â”‚   â”œâ”€â”€ entities/             # Core entities
â”‚   â”œâ”€â”€ value_objects/        # Domain values
â”‚   â”œâ”€â”€ services/             # Domain services
â”‚   â”œâ”€â”€ repositories/         # Repository interfaces
â”‚   â””â”€â”€ exceptions/           # Domain exceptions
â”‚
â”œâ”€â”€ ğŸ”§ infrastructure/        # Infrastructure Layer
â”‚   â”œâ”€â”€ repositories/         # Repository implementations
â”‚   â”œâ”€â”€ external/             # External clients
â”‚   â”œâ”€â”€ processors/           # Document processing
â”‚   â””â”€â”€ config/               # Configuration
â”‚
â”œâ”€â”€ ğŸ› ï¸ shared/               # Shared utilities
â”œâ”€â”€ ğŸ§ª tests/                # Test organization
â”œâ”€â”€ ğŸ“¦ storage/               # Data storage
â””â”€â”€ ğŸ“„ documents/             # Input documents
```

## ğŸš€ CORE FUNCTIONALITY

### **Main API**

```bash
# Chat with documents
POST /api/v1/chat/ask
{
  "message": "Como escrever um ofÃ­cio oficial?",
  "session_id": null  # or existing session UUID
}

# System endpoints
GET /              # API info
GET /health        # Health check
GET /docs          # Interactive docs
```

### **Key Components**

- **Entities**: Document, ChatSession, Message, DocumentChunk, Embedding
- **Use Cases**: ChatWithDocumentsUseCase (main conversation flow)
- **Services**: ChatService, SearchService, DocumentService
- **Infrastructure**: PostgresVectorRepository, PostgresSessionRepository, OpenAIClient

## ğŸ”§ TECHNICAL STACK

### **Core Technologies**

- **FastAPI**: Async web framework
- **PostgreSQL + pgvector**: Vector database for embeddings
- **Redis**: Session storage
- **OpenAI**: GPT-4o-mini + text-embedding-3-small
- **Docker**: Containerization with optimized builds

### **Architecture Patterns**

- **Clean Architecture**: Dependency inversion
- **Repository Pattern**: Data access abstraction
- **Dependency Injection**: Testable components
- **Use Case Pattern**: Application service layer

## ğŸ› ï¸ DEVELOPMENT WORKFLOW

### **Quick Start**

```bash
# Docker (recommended)
docker-compose up -d

# Local development (ALWAYS activate venv first)
source .venv/bin/activate  # MANDATORY STEP
python -m interface.main

# Health check
curl http://localhost:8000/health
```

### **Adding Features**

1. **Domain First**: Define entities and business rules
2. **Use Cases**: Implement application logic
3. **Infrastructure**: Add external integrations
4. **Interface**: Create API endpoints
5. **Tests**: Unit â†’ Integration â†’ E2E

### **Docker Optimization**

- Uses `.dockerignore` for clean builds
- Single `COPY . .` instead of multiple COPYs
- Removed unnecessary PyTorch (sentence-transformers)
- Build time: ~180s (was 300s+)

## ğŸ“‹ CONFIGURATION

### **Key Environment Variables**

```bash
# Required
OPENAI_API_KEY=your_key_here

# PostgreSQL (required for production)
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres123
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=intelligent_document_search
POSTGRES_SSL_MODE=disable

# Optional (with defaults)
API_HOST=0.0.0.0
API_PORT=8000
REDIS_HOST=localhost
CHUNK_SIZE=500
MAX_MESSAGES_PER_SESSION=100
```

## ğŸ§ª TESTING STRATEGY

```
tests/
â”œâ”€â”€ unit/          # Fast, isolated (domain/application/infrastructure)
â”œâ”€â”€ integration/   # Service integration (api/repositories)
â””â”€â”€ e2e/          # Full system tests
```

**Testing Principles**:

- **Domain**: Pure unit tests, no mocks
- **Application**: Mock infrastructure dependencies
- **Infrastructure**: Integration tests with real services
- **API**: End-to-end tests with full stack

## ğŸš¨ DEVELOPMENT RULES

### **CRITICAL PRINCIPLES**

1. **Domain Independence**: Domain layer has NO external dependencies
2. **Dependency Direction**: Always inward (Interface â†’ Application â†’ Domain)
3. **Interface Segregation**: Small, focused interfaces
4. **Single Responsibility**: Each class has one reason to change
5. **Open/Closed**: Open for extension, closed for modification

### **CODE STANDARDS**

- **ALWAYS activate venv first**: `source .venv/bin/activate` before any Python command
- **NEVER comments in code !IMPORTANT** (self-documenting preferred)
- **No automatic README updates** (manual only)
- **No explanations in files** (code should be clear)
- **Generate code only when explicitly requested**
- **Always question requirements** and suggest improvements

### **ENVIRONMENT CONFIGURATION (.env)**

**CRITICAL**: The AI does **NOT** have access to the `.env` file by default.

**Rules for .env management**:

- **NEVER** assume .env values - always ask the user
- **NEVER** try to read/write .env directly
- **ALWAYS** ask user to add/modify/remove environment variables
- **ALWAYS** ask user to confirm current .env values when debugging
- When suggesting .env changes, provide exact variable names and values
- User will manually update .env and confirm changes

**Example interaction**:

```
âŒ BAD: "I'll add POSTGRES_SSL_MODE=disable to your .env"
âœ… GOOD: "Please add this to your .env: POSTGRES_SSL_MODE=disable"
```

### **TESTING REQUIREMENTS**

- **Domain**: Pure unit tests, no mocks
- **Application**: Mock infrastructure dependencies
- **Infrastructure**: Integration tests with real services
- **API**: End-to-end tests with full stack

---

This represents a **complete evolution** from POC to production-ready system following Clean Architecture and modern Python practices.
